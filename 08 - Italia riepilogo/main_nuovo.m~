%{

    Situazione Italia: prelockdown, lockdown

    Alla fine plot dela simulazione del modello in entrambe le fasi.

%}

close all
clear
clc

global t_0 t_u t_c Nass Ibar Rbar date beta gamma

% controllo blocchi codice:
lock      = 1;
riepilogo = 1;

%% DATI

% Upload dati protezione civile
tmp = fullfile('..','00 - dpc_data','2020-05-22','dati-andamento-nazionale');
%tmp = fullfile('..','00 - dpc_data','2020-06-30','dati-andamento-nazionale');

[status,result]     = fileattrib(tmp);
path_folder         = result.Name;                  % percorso alla cartella
[date,Ibar,Rbar]    = data_read_dpc(path_folder);
% Attenzione: gli indici in matrice partono da 1 e tm parte da 0
% date(i), Ibar(i), Rbar(i) e' in corrispondenza con t_i-1

% DATI:
t_0 = 0;                           % 2020-02-24
t_u = 14;                          % 2020-03-09 t finale senza controllo
t_c = length(date)-1;              % decremento perche' parto da 0
Nass = 60317000;                   % popolazione italiana istat 11.02.2020
%Nass = 6e9;                       % imbrogliando così arrivo a k~1e-5 (in
                                   % main lockdown
                                   
%% Pre-Lockdown


% controlo immagini e figure
ssens = 0;      % analisi sensitività
ffig  = 1;      % stampare figure
ssave = 0;      % salvare immagine

K0  = [0.5,0.1];                    % guess iniziale per [beta,gamma]
pnt = 5;                            % piu nodi per migliore risoluzione sistema minquad

[beta, gamma, tpl, xpl] = main_prelock(K0, pnt, ssens, ffig, ssave);

if lock == 0
    return
end    

%% Lockdown

pplot = 0;  % stampare funzionale
oold  = 0;  % stampo il funzionale nella vecchia maniera
ffig  = 1;  % stampare le figura
ssave = 1;  % salvare le figure


% 1. stimo i K discreti

% definisco la finestra
window.h   = 1;              % daily time step
window.kl  = 3;
window.kr  = 4;
k0_c       = 1e-5;                             % guess iniziale (ottengo sempre gli stessi k_c)
kspan      = t_u:1:t_c-window.kr*window.h;     % intervallo ricerca k discreto
window.pnt = 100;                              % aumento numero nodi integrazione


% 2. Fitto i k_c discreti ottenuti e ricavo k(t)

% a =   3.387e-06;  %(3.319e-06, 3.456e-06)
% b =   0.0003582;  %(0.0003515, 0.000365)
% c =    0.002778;  %(0.00263, 0.002926)

a = 1e-6; b = 1e-4; c = 1e-3;
kguess = [a,b,c,];

% in tl, xl ho simulato il modello ottenuto aggiungendo il parametro
% ricavato mediante ottimizzazione
[tl,xl,A] = main_lockdown(k0_c,kspan, window, kguess, pplot, oold, ffig, ssave);

% update function
K = @(t) -A(1)*t.^2 + A(2)*t - A(3);

if riepilogo == 0
    return
end    

%% Figure: riepilogo

fig = figure();

tt = [tpl;tl]';
ii = [xpl(:,2);xl(:,2)]';

%plot(tt,ii,'SeriesIndex',3,'Linewidth',2)
plot(tt,ii,'Linewidth',2,'color',[0 0 0]+0.3)

hold on
plot(t_0:t_c,Ibar,'o',...
    'MarkerSize',3,...
    'MarkerEdgeColor','red',...
    'MarkerFaceColor',[1 .6 .6])

ax = gca;
ax.XTick = [t_0,t_u,37,67,t_c];
ax.XTickLabel = date([t_0,t_u,37,67,t_c]+1);
ax.XTickLabelRotation = 45;
xline(t_u,':','inizio Lockdown')
%axis([0 3e5])      % come albi

box on
legend('I','$I_{bar}$','Location','Best');
ylabel('casi confermati');
set(gca,'FontSize',12.5)

% imposto latex come inteprete per i grafici
set(groot,...
    'defaulttextinterpreter','latex',...
    'defaultAxesTickLabelInterpreter','latex',...
    'defaultLegendInterpreter','latex');  

if ssave == 1
    exportgraphics(fig,['italia_riepilogo ' num2str(date(t_c+1)) '.pdf'],'ContentType','vector',...
                   'BackgroundColor','none')
end
